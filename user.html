<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile - FindSell</title>
    <link rel="stylesheet" href="userStyle.css">
</head>
<body>
    <div class="welcome-message">
        Welcome! <span id="usrem"></span>
    </div>

    <header class="header">
        <div class="nav-container">
            <a href="index2.html">
                <img src="Selling_transparent-.png" alt="FindSell" class="logo">
            </a>
            
            <div class="search-wrapper">
                <input type="text" class="search-input" placeholder="Search for items...">
                <button class="search-button">
                    <!-- SVG for search icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="m21 21-4.3-4.3"/>
                    </svg>
                </button>
            </div>

            <div class="nav-buttons">
                <div class="account-wrapper" style="position: relative;">
                    <button class="my-account-btn" id="account-btn">My Account</button>
                    <div class="dropdown" style="display:none;">
                        <a href="myaccount.html">My Account</a>
                        <a href="myproduct.html">My Products</a>
                        <a href="myfriend.html">My Friends</a>
                        <a href="myaward.html">Awards</a>
                    </div>
                </div>
                <a href="product.html" class="sell-btn">Sell</a>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div class="user-profile">
            <h1>User Profile</h1>
            <div class="profile-section">
                <img id="profile-picture" src="default-avatar.png" alt="Profile Picture" class="profile-image">
                <input type="file" id="profile-upload" accept="image/*" style="display: none;">
                
                <div class="profile-info">
                    <p><strong>Name:</strong> <span id="user-name"></span></p>
                    <p><strong>Email:</strong> <span id="user-email"></span></p>
                    <p><strong>Account Bio:</strong> <span id="user-bio"></span></p>
                </div>
            </div>

            <div class="recent-activity">
                <h2>Recent Activity</h2>
                <p>No recent activity.</p>
            </div>

            <div class="user-products">
                <h2>Products</h2>
                <div id="products-container"></div>
            </div>

            <div class="user-comments">
                <h2>Comments</h2>
                <div id="comments-container"></div>
                <div class="comment-form">
                    <textarea id="comment-input" placeholder="Write a comment..."></textarea>
                    <button id="submit-comment">Post Comment</button>
                </div>
            </div>
        </div>
    </main>


</body>
</html>


    <script>
        // Initialize variables
        const others = localStorage.getItem("selectedUser");
        const other = JSON.parse(others);
        const userId = localStorage.getItem("usrid");
        const usrmail = localStorage.getItem("usremail");
        document.getElementById("usrem").innerHTML = usrmail;

        // Dropdown functionality
        const dropd = document.querySelector('.dropd');
        const dropdown = document.querySelector('.dropdown');

        dropd.addEventListener('click', function(event) {
            event.stopPropagation();
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        });

        document.addEventListener('click', function(event) {
            if (!dropdown.contains(event.target) && !dropd.contains(event.target)) {
                dropdown.style.display = 'none';
            }
        });

        // Profile image handling
        function base64ToUrl(base64) {
            if (!base64 || !base64.includes(',')) return '';
            const byteCharacters = atob(base64.split(',')[1]);
            const byteArrays = [];

            for (let offset = 0; offset < byteCharacters.length; offset++) {
                byteArrays.push(byteCharacters.charCodeAt(offset));
            }

            const blob = new Blob([new Uint8Array(byteArrays)], { type: 'image/png' });
            return URL.createObjectURL(blob);
        }

        // Set profile information
        if (other.otheravatar === 'unknown') {
            document.getElementById("img").src = 'default-avatar.png'; // Add a default avatar image
        } else {
            document.getElementById("img").src = base64ToUrl(other.otheravatar);
        }

        document.getElementById("name-display").textContent = other.othername;
        document.getElementById("email-display").textContent = other.otheremail;
        document.getElementById("bio-display").textContent = other.otherbio;

        // API configuration
        const APIKEY = "67971683f9d2bb616f181e2b";
        const testurl = "https://assignmentfed-fb7a.restdb.io/rest/usercomment";

        // Load comments
        async function loadComments() {
            try {
                const response = await fetch(testurl, {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                        "x-apikey": APIKEY,
                        "Cache-Control": "no-cache",
                    },
                });

                const comments = await response.json();
                const container = document.getElementById("reviews-container");
                container.innerHTML = '';

                comments.forEach(comment => {
                    if (comment.posterid === userId) {
                        const commentElement = document.createElement("div");
                        commentElement.className = "comment-item";
                        commentElement.innerHTML = `
                            <div class="comment-header">
                                <img src="${base64ToUrl(comment.posteravatar) || 'default-avatar.png'}" alt="User" class="comment-avatar">
                                <strong>${comment.name}</strong>
                            </div>
                            <p class="comment-text">${comment.comment}</p>
                            <hr>
                        `;
                        container.appendChild(commentElement);
                    }
                });
            } catch (error) {
                console.error("Error loading comments:", error);
            }
        }

        // Load products
        async function loadProducts() {
            try {
                const response = await fetch("https://jackm-ff5c.restdb.io/rest/product", {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                        "x-apikey": APIKEY,
                        "Cache-Control": "no-cache",
                    },
                });

                const products = await response.json();
                const container = document.getElementById("u-p");
                container.innerHTML = '';

                const userProducts = products.filter(product => product.id === other.otherid);

                if (userProducts.length === 0) {
                    container.innerHTML = '<p>This User Has No Products</p>';
                    return;
                }

                userProducts.forEach(product => {
                    const productElement = document.createElement("div");
                    productElement.className = "product-card";
                    const imageUrl = base64ToUrl(product.url);

                    productElement.innerHTML = `
                        <img src="${imageUrl}" alt="${product.name}" class="product-image"
                            data-pid="${product.productID}"
                            data-usrid="${userId}"
                            data-price="${product.price}"
                            data-tag="${product.tag}"
                            data-des="${product.Description}"
                            data-brand="${product.Brand}"
                            data-url="${imageUrl}"
                            data-name="${product.name}">
                        <div class="product-info">
                            <h3>${product.name || 'Unnamed Product'}</h3>
                            <p class="price">Â¥${product.price || 0}</p>
                            <p class="description">${product.Description || 'No description available'}</p>
                        </div>
                    `;

                    container.appendChild(productElement);
                });
            } catch (error) {
                console.error("Error loading products:", error);
            }
        }

        // Handle product clicks
        document.getElementById("u-p").addEventListener("click", function(event) {
            const target = event.target;
            if (target.classList.contains("product-image")) {
                const productData = {
                    productID: target.dataset.pid,
                    userID: target.dataset.usrid,
                    price: target.dataset.price,
                    tag: target.dataset.tag,
                    description: target.dataset.des,
                    brand: target.dataset.brand,
                    url: target.dataset.url,
                    name: target.dataset.name,
                };

                localStorage.setItem("selectedProduct", JSON.stringify(productData));
                window.location.href = "product.html";
            }
        });

        // Handle comment submission
        document.getElementById("publish-btn").addEventListener("click", async function() {
            const commentInput = document.getElementById("comment-input");
            const comment = commentInput.value.trim();

            if (!comment) {
                alert("Please enter a comment before submitting.");
                return;
            }

            try {
                const response = await fetch(testurl, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "x-apikey": APIKEY,
                        "Cache-Control": "no-cache",
                    },
                    body: JSON.stringify({
                        usrid: other.otherid,
                        name: localStorage.getItem("usrname"),
                        comment: comment,
                        posterid: userId,
                        posteravatar: other.otheravatar
                    }),
                });

                if (response.ok) {
                    alert("Comment posted successfully!");
                    commentInput.value = "";
                    loadComments();
                } else {
                    throw new Error("Failed to post comment");
                }
            } catch (error) {
                alert("Failed to post comment. Please try again.");
                console.error(error);
            }
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            loadProducts();
            loadComments();
        });
    </script>
</body>
</html>