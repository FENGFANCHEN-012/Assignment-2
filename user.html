<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile - FindSell</title>
    <link rel="stylesheet" href="userStyle.css">
    <link rel="stylesheet" href="css.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="my.css">
   
    <style>
        /* don't delete this first style*/
        .auth-panel {
            
            margin-right:30em;
            margin-top:15em;
            display: none;

            position:fixed;
            top: 80px;
            right: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            min-width: 300px;
        
        }
        .product-image{
         width:50vw;
         height:40vw;
         background-position: center;
        }
         .product-page {
             font-family: Arial, sans-serif;
             color: #333;
             line-height: 1.6;
             max-width: 1200px;
             margin: 0 auto;
             padding: 20px;
         }
 
         .product-header {
             display: flex;
             justify-content: space-between;
             align-items: center;
             border-bottom: 2px solid #f0f0f0;
             padding-bottom: 10px;
         }
 
         .product-header h1 {
             font-size: 24px;
             font-weight: bold;
             color: #007BFF;
         }
 
         .product-main {
             display: flex;
             gap: 20px;
             margin-top: 20px;
         }
 
         .product-image-section {
             flex: 2;
         }
 
         .product-image {
             width: 100%;
             height: auto;
             border-radius: 8px;
             box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
         }
 
         .product-thumbnails {
             display: flex;
             gap: 10px;
             margin-top: 10px;
         }
 
         .product-thumbnails img {
             width: 60px;
             height: 60px;
             border: 2px solid #ddd;
             border-radius: 4px;
             cursor: pointer;
         }
 
         .product-thumbnails img:hover {
             border-color: #007BFF;
         }
 
         .product-details {
             flex: 3;
             display: flex;
             flex-direction: column;
             justify-content: space-between;
         }
 
         .product-price {
             font-size: 28px;
             font-weight: bold;
             color: #E74C3C;
             margin: 10px 0;
         }
 
         .btn-buy {
             padding: 12px 20px;
             background-color: #4CAF50;
             color: #fff;
             border: none;
             border-radius: 4px;
             font-size: 16px;
             cursor: pointer;
             margin-top: 20px;
         }
 
         .btn-buy:hover {
             background-color: #45a049;
         }
 
         .product-description {
             margin-top: 20px;
             border-top: 1px solid #f0f0f0;
             padding-top: 10px;
         }
 
         .product-reviews {
             margin-top: 40px;
         }
 
         .review-item {
             border-bottom: 1px solid #f0f0f0;
             padding: 10px 0;
         }
 
         .comment-box {
             margin-top: 20px;
         }
 
         .comment-input {
             width: 95%;
             padding: 10px;
             margin: 10px 0;
             border: 1px solid #ddd;
             border-radius: 4px;
             font-size: 14px;
         }
 
         .btn-publish {
             background-color: #007BFF;
             color: white;
             padding: 10px 20px;
             border: none;
             border-radius: 4px;
             cursor: pointer;
         }
 
         .btn-publish:hover {
             background-color: #0056b3;
         }
 
         .footer {
             text-align: center;
             padding: 20px;
             background-color: #f9f9f9;
             margin-top: 40px;
         }
     </style>
    <style>
        .imgs {
            width: 5vw; 
            height: 5vw; 
        }
        hr{
            width:10vw;
        }
        .product-item {
            width: 85%;
        }

        #img {
            height: 10vw;
            width: 10vw;
            display: flex;
            margin-right: 20vw;
            justify-content: center;
        }

        .show {
            display: none;
        }
    </style>
    
</head>
<script>
      
    document.addEventListener('DOMContentLoaded', async () => {
        if (!userId) {
            document.getElementById('message').textContent = 'Please log in before checking in.';
            document.getElementById('signInButton').disabled = true;
            return;
        }})
</script>

   
<script>
    let others = localStorage.getItem("selectedUser")
    let other = JSON.parse(others)
    let userId=  localStorage.getItem("usrid")
    let usrmail = localStorage.getItem("usremail");
  
</script>
<body>
    <div class="welcome-message">
        Welcome! <span id="usrem"></span>
    </div>

    <header class="header">
        <div class="nav-container">
            <a href="index2.html">
                <img src="Selling_transparent-.png" alt="FindSell" class="logo">
            </a>
            
            <div class="search-wrapper">
                <input type="text" class="search-input" placeholder="Search for items...">
                <button class="search-button">
                    <!-- SVG for search icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="m21 21-4.3-4.3"/>
                    </svg>
                </button>
            </div>

            <div class="nav-buttons">
                <div class="account-wrapper" style="position: relative;">
                    <button class="my-account-btn" id="account-btn">My Account</button>
                    <div class="dropdown" style="display:none;">
                        <a href="myaccount.html">My Account</a>
                        <a href="myproduct.html">My Products</a>
                        <a href="myfriend.html">My Friends</a>
                        <a href="myaward.html">Awards</a>
                    </div>
                </div>
                <a href="product.html" class="sell-btn">Sell</a>
            </div>
        </div>
    </header>
  
    <main class="main-content">

        <div class="main" style='margin-top:10vw;height:85vw;align-items:start'>
            <div class="product-panel">
                <div class="product-header">
                    <h1 id="u-n">User</h1>
                </div>
    
                <div class="product-content" style="align-items: center;justify-content:center;width:100%">
                    <img id="img" src="" >
                    <section id="talk">Talk To Him</section>
                    <button id="add"> Add Friend</button>
                    
                    <div class="auth-panel" id="login-panel">
                        <div class="auth-content">
                            <h3>Send Friend Request</h3>
                            <section style="display:flex">
                               
            
                            </section>
                            <h4>Description of Yourself</h4>
                            <textarea placeholder="Hi! Nice To Meet You" id="self">

                            </textarea>
                            <button id="send">Send</button>
                           
                        </div>
                    </div>
                    <script>
                        const friendlist = new Set(JSON.parse(localStorage.getItem("friend") || "[]"));
                        test2account = "https://fedpart2-130c.restdb.io/rest/account"
                            test3  = "67a9a09c020c068f77e6537d"
                           const userID = localStorage.getItem("usrid")
                           document.addEventListener("DOMContentLoaded", function () {
                            const authContent = document.getElementsByClassName("auth-panel")[0];
                            const sendRequestBtn = document.getElementById("add");
                            if(friendlist.has(other.otherid)){
                                 sendRequestBtn.style.display = 'none'
                            }
                          
                                
                                data.forEach(data=>{
                                if(friendlist.has(data.usrid)){
                                    sendRequestBtn.style.display='none'
                                }
                            })} )
                           const  testmessage = "https://assignmentfed-fb7a.restdb.io/rest/message"
                           
                            sendRequestBtn.addEventListener("click", function (event) {
                                authContent.style.display = "block";
                                event.stopPropagation();
                            });
                        
                          
                            authContent.addEventListener("click", function (event) {
                                event.stopPropagation(); // prevent body click
                            });
                        
                            // press other place hide panel
                            document.body.addEventListener("click", function () {
                                authContent.style.display = "none";
                            });
                              
                        

                              document.getElementById("send").addEventListener("click",function(event){
                               try{
                                const s1 = {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                        "x-apikey": APIKEY,
                                        "Cache-Control": "no-cache",
                                    },
                                    body: JSON.stringify({
                                        usrid : other.otherid,
                                        type: "Frequest",
                                      content: document.getElementById("self").value,
                                      posterid:userID
                                    }
                                    )
                                        
                                     
                                };
                                const msg = fetch(testmessage,s1)
                                .then(response=>{
                                    if(response.ok){
                                        alert("Friend Request Sent")
                                    }
                                    if(!reponse.ok){
                                        alert("fail to send friend Request, try again ")
                                    }
                                })
                            }
                            catch(error){
                                alert("Friend Request fail")
                            }
                            
                            })
                            document.getElementById("talk").addEventListener("click",function(){
                                window.location.href='http://127.0.0.1:5500/talk.html';
                            })   
                        </script>
                    
                    <div class="product-item" id='info' style="margin-bottom: 20px;">
                       
                        <p><strong>Name:</strong> <span class="sub" id="name-display"></span></p>
                        
                        <p><strong>Email:</strong> <span class="sub" id="email-display"></span></p>
                        <p><strong>Account Bio:</strong> <span class="sub" id="bio-display"></span></p>
                       
                    </div>
    
                    <div class="product-item" style="margin-bottom: 20px;">
                        <h3>Recent Activity</h3>
                        <p>No recent activity.</p>
                    </div>
                    <div class="product-item"  style="margin-bottom: 20px;">
                        <h3>Product:</h3>
                        <section id="u-p"></section>
                    </div>
                    <div class="product-item"  style="margin-bottom: 20px;">
                        <h3>Comment</h3>
                        
                        <section class="product-reviews">
                            <h2>User Reviews</h2>
                            <section id="comment">
                
                            </section>
                            <div id="reviews-container"></div>
                            <div class="comment-box">
                                <textarea id="comment-input" class="comment-input"  placeholder="Write your comment here..."></textarea>
                                <button id="publish-btn" class="btn-publish">Publish</button>
                            </div>
                        </section>
                    </div>
    
              
            </div>
        </div>
    </main>

    <div class="footer">
        <p>&copy; 2025 My Company. All rights reserved.</p>
    </div>
     
    <script>
        const accountBtn = document.getElementById('account-btn');
        const dropdown = document.querySelector('.dropdown');
        
        accountBtn.addEventListener('click', (event) => {
            event.stopPropagation();
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        });

        document.addEventListener('click', (event) => {
            if (!dropdown.contains(event.target) && event.target !== accountBtn) {
                dropdown.style.display = 'none';
            }
        });

        let comments = "https://jackm-ff5c.restdb.io/rest/usercomment"
        let testcomments = "https://assignmentfed-fb7a.restdb.io/rest/usercomment"
        function base64ToUrl(base64) {
          
            const byteCharacters = atob(base64.split(',')[1]); 
            const byteArrays = [];
        
            for (let offset = 0; offset < byteCharacters.length; offset++) {
                byteArrays.push(byteCharacters.charCodeAt(offset));
            }
        
            
            const blob = new Blob([new Uint8Array(byteArrays)], { type: 'image/png' });
        
           
            return URL.createObjectURL(blob);
        }
        // if user has no avatar make it null
        if(other.otheravatar = 'unknown')
        {
            document.getElementById("img").src= null
        }
        else{
            const imageUrl = base64ToUrl(other.otheravatar);
            document.getElementById("img").src=imageUrl
        }
       // fetch the data of user selected
        document.getElementById("name-display").innerText = other.othername
        document.getElementById("email-display").innerText = other.otheremail
        document.getElementById("bio-display").innerText = other.otherbio
        account = "https://jackm-ff5c.restdb.io/rest/account"
        testaccount = "https://assignmentfed-fb7a.restdb.io/rest/account"
         
        commenturl = "https://jackm-ff5c.restdb.io/rest/usercomment"
        commenttesturl   = "https://assignmentfed-fb7a.restdb.io/rest/usercomment"
        const producturl =  "https://jackm-ff5c.restdb.io/rest/product"
        const testproducturl = "https://assignmentfed-fb7a.restdb.io/rest/product";
        api = "678fa7439bd0c87432ac8bee"
         test = "67971683f9d2bb616f181e2b"
        test3  = "67a9a09c020c068f77e6537d"
       const APIKEY = api;
    
        
       
      
        async function loadComments(){
            const set2 = {
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                    "x-apikey": APIKEY,
                    "Cache-Control": "no-cache",
                },
            };
    let comm = document.getElementById("reviews-container")
            comm.innerHTML=''
            const com = await  fetch(commenturl,set2)
            const response = await com.json();
               response.forEach(comment=>{
                if(comment.posterid==userId){
                    let userscomment = document.createElement("div")
                    userscomment.innerHTML=`
                     <p><img class='imgs' src='' > <strong><p style='margin-bottom:2vw'>${comment.name}:  ${comment.comment}</p></p> 
                     <p>Posted Time: <p class='time'> hha </p> </p>
                
            `
            let imgElement = userscomment.querySelector(".imgs");
            let time = userscomment.querySelector(".time");
             time.innerHTML= comment.time;
            if (comment.posteravatar == 'unknown') {
                imgElement.src = "6596121.png";
            } else {
                imgElement.src = base64ToUrl(comment.posteravatar);
            }
            comm.appendChild(userscomment)
                }
               })
           
            }
           
          
       let hasproduct = [];
        async  function loadProducts() {
           
            try {

                const set = {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                       "x-apikey":APIKEY,
                        "Cache-Control": "no-cache",
                    },
                }
               
                document.getElementById("u-p").innerHTML='';
              
                const response = await fetch(producturl, set);console.log(response)
                const data = await response.json();
              
               
                 
               data.forEach(product => {
                  
                if(product.id===other.otherid){
                 hasproduct.push(1)
                }}
                    )

                if(hasproduct.length == 0){
                    
                        document.getElementById("u-p").innerHTML='This User Has No Product'
                    
                }
                else{
                    console.warn('sd');
                data.forEach(product => {
                  
                    if(product.id===other.otherid){
                    const productItem = document.createElement("div");
                    productItem.className = "product-item";
                    productItem.dataset.id = product._id; 
                    const base64Data = `${product.url}`; 
                    const contentType = "image/png"; 
                    
                   
                    function base64ToBlob(base64, contentType) {
                        const byteCharacters = atob(base64);
                        const byteArrays = [];
                        for (let offset = 0; offset < byteCharacters.length; offset += 512) {
                            const slice = byteCharacters.slice(offset, offset + 512);
                            const byteNumbers = new Array(slice.length);
                            for (let i = 0; i < slice.length; i++) {
                                byteNumbers[i] = slice.charCodeAt(i);
                            }
                            byteArrays.push(new Uint8Array(byteNumbers));
                        }
                        return new Blob(byteArrays, { type: contentType });
                    }
                    
                    
                    const blob = base64ToBlob(base64Data, contentType);
                    const blobUrl = URL.createObjectURL(blob);
                    
                    
                  
                    productItem.innerHTML = `
                       <section style="width:100%;height:20vw" >
                        <img  src=${blobUrl} data-pid=${product.productID} data-usrid=${localStorage.getItem('usrid')} data-price='${product.price}' data-tag='${product.tag}' data-des ='${product.Description}' data-brand='${product.Brand}' data-url='${blobUrl}' data-name='${product.name}' src=${blobUrl} alt="Product Image" class="product-image" style="backrgound-size:cover;background-position:center">
                       </section>
                        <div class="product-info">
                            <h3 class="name">${product.name || 'Unnamed Product'}</h3>
                            <p class="product-price">Price: ¥${product.price || 0}</p>
                            <p class="product-reviews">Comment: ${product.comments || 'No comments'}</p>
                            
                        </div>
                    `;
                     console.log(localStorage.getItem("usrid"));
                   console.warn('sd');
                     document.getElementById("u-p").appendChild(productItem);
                    
                }})}
            }
        
            catch (error) {
                console.error("Failed to load products:", error);
            }
        }
        
        document.getElementById("u-p").addEventListener("click", function (event) {
            let target = event.target;
            if (target.classList.contains("product-image")) {

                let productData = {
                    productID: target.getAttribute("data-pid"),
                    userID: target.getAttribute("data-usrid"),
                    price: target.getAttribute("data-price"),
                    tag: target.getAttribute("data-tag"),
                    description: target.getAttribute("data-des"),
                    brand: target.getAttribute("data-brand"),
                    url: target.getAttribute("data-url"),
                    name: target.getAttribute("data-name"),
                };
        
                localStorage.setItem("selectedProduct", JSON.stringify(productData));
        
             
                window.location.href = "product.html";
            }
        });
        document.addEventListener('DOMContentLoaded', () => {
            loadProducts();
            loadComments();
           
            

        });





        document.getElementById("publish-btn").addEventListener("click", async function() {
            const commentInput = document.getElementById("comment-input");
            const comment = commentInput.value.trim();
           
            if (!comment) {
                alert("Please enter a comment before submitting.");
                return;
            }
        
            const productId = document.querySelector(".product-item").dataset.id;  
            const userId = localStorage.getItem("usrid");  
            const username = localStorage.getItem("usrname")
            
         
            const newComment = {
                usrid: other.otherid,
                name:localStorage.getItem("usrname"),
                comment: comment,
                posterid:userId,
                posteravatar:other.otheravatar,
                time: new Date()
            };
        
            const response = await fetch(commenturl, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "x-apikey": APIKEY,
                    "Cache-Control": "no-cache",
                },
                body: JSON.stringify(newComment),
            });
        
            if (response.ok) {
                alert("Comment posted!");
                commentInput.value = ""; 
                loadComments(productId);  
            } else {
                alert("Failed to post comment. Please try again.");
            }
        });
      
      


    
            

     
    </script>
</body>
</html>


 
</body>
</html>